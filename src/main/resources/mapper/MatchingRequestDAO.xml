<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IMatchingRequestDAO">

    <!-- 거래 id와 거래유형으로 해당 거래 id에 매칭신청한 사용자 목록을 불러오는 메소드-->
    <select id="listRequestByTransactionIdType" resultType="com.team.mvc.DTO.MatchingRequestDTO">
        SELECT TRANSACTION_ID, TRANSACTION_TYPE, USER_CODE, USER_NICKNAME
             , RENTAL_START_DATE, RENTAL_END_DATE, RENTAL_DURATION
             , RENTAL_PAY, TRUST, RENTAL_HISTORY, REQUESTED_DATE, NVL(PAYMENT_DATE, '결제대기') AS PAYMENT_DATE
             , MATCHING_REQ_ID
        FROM VW_RENTAL_APPLICANT
        WHERE TRANSACTION_ID = #{transaction_id} AND TRANSACTION_TYPE = #{transaction_type}
    </select>

    <!-- 스토렌 매칭 신청(insert) -->
    <insert id="insertStorenMatchingRequest" parameterType="com.team.mvc.DTO.MatchingRequestDTO">
        INSERT INTO STOREN_MATCHING_REQ (
            STOREN_MATCHING_REQ_ID
            , STOREN_MATCHING_REQ_USER_ID
            , STOREN_IRA_ID
            , RENTAL_START_DATE
            , RENTAL_END_DATE
            , REQUESTED_DATE
        )
        VALUES (
                   STOREN_MATCHING_REQ_SEQ.NEXTVAL
                   , #{user_code}
                   , (SELECT INSPEC_RESULT_ACTION_ID FROM STOREN_IRA WHERE STOREN_ID = #{transaction_id})
                   , TO_DATE(#{rental_start_date}, 'YYYY-MM-DD')
                   , TO_DATE(#{rental_end_date}, 'YYYY-MM-DD')
                   , SYSDATE
               )
    </insert>

    <!-- 해당 스토렌id에 해당 유저가 매칭신청을 했다면 매칭 정보 반환 -->
    <select id="getMatchingByStorenAndUser" resultType="com.team.mvc.DTO.MatchingRequestDTO">
        SELECT TRANSACTION_ID, TRANSACTION_TYPE, USER_CODE, USER_NICKNAME
             , RENTAL_START_DATE, RENTAL_END_DATE, RENTAL_DURATION
             , RENTAL_PAY, TRUST, RENTAL_HISTORY, REQUESTED_DATE, NVL(PAYMENT_DATE, '결제대기') AS PAYMENT_DATE
             , MATCHING_REQ_ID
        FROM VW_RENTAL_APPLICANT
        WHERE TRANSACTION_ID = #{storenId} AND USER_CODE = #{user_code} AND TRANSACTION_TYPE = '스토렌_매칭신청'
    </select>

    <!-- 스토렌 매칭 승인(1. 매칭 완료 테이블에 insert) -->
    <insert id="insertStorenMatchingDone">
        INSERT INTO STOREN_MATCHING_DONE(STOREN_MATCHING_DONE_ID, STOREN_MATCHING_REQ_ID, APPROVED_DATE)
        VALUES(STOREN_MATCHING_DONE_SEQ.NEXTVAL, #{requestId}, SYSDATE);
    </insert>

    <!-- 해당 스토렌ID의 다른 매칭 요청 삭제(2. 매칭 신청 테이블에서 delete) -->
    <delete id="deleteOtherStorenRequests">
        DELETE
        FROM STOREN_MATCHING_REQ
        WHERE storen_ira_id = (select storen_ira_id
                               from storen_ira
                               where storen_id = #{storenId})
          AND STOREN_MATCHING_REQ_ID != #{requestId}
    </delete>

</mapper>