<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.ICouponDAO">
    <resultMap id="couponResultMap" type="com.team.mvc.DTO.CouponDTO">
        <result column="보유쿠폰ID" property="coupon_id"/>
        <result column="회원코드" property="user_code"/>
        <result column="회원닉네임" property="nickname"/>
        <result column="쿠폰이름" property="coupon_name"/>
        <result column="쿠폰종류" property="coupon_type"/>
        <result column="쿠폰할인율" property="coupon_discount"/>
        <result column="쿠폰유효개월수" property="coupon_month"/>
        <result column="쿠폰발행일" property="coupon_created_date"/>
        <result column="쿠폰만료일" property="coupon_end_date"/>
        <result column="쿠폰사용완료일" property="coupon_used_date"/>
    </resultMap>

    <!-- 해당 유저가 가진 쿠폰 리스트 전체 조회(사용만료일 임박순) -->
    <select id="listCouponByUserCode" resultType="com.team.mvc.DTO.CouponDTO" resultMap="couponResultMap">
        SELECT "보유쿠폰ID", "회원코드", "회원닉네임"
             , "쿠폰이름", "쿠폰종류", "쿠폰할인율", "쿠폰유효개월수"
             , TO_CHAR("쿠폰발행일", 'YYYY-MM-DD') AS "쿠폰발행일", TO_CHAR("쿠폰만료일", 'YYYY-MM-DD') AS "쿠폰만료일"
             , TO_CHAR("쿠폰사용완료일", 'YYYY-MM-DD') AS "쿠폰사용완료일"
        FROM VW_COUPON_MANAGEMENT
        WHERE "회원코드" = #{user_code}
        ORDER BY "쿠폰만료일" DESC
    </select>

    <!-- 해당 유저가 가진 쿠폰 리스트 중 날짜 유효한 리스트만 조회(사용만료일 임박순) -->
    <select id="listValidCouponByUserCode" resultType="com.team.mvc.DTO.CouponDTO" resultMap="couponResultMap">
        SELECT "보유쿠폰ID", "회원코드", "회원닉네임"
             , "쿠폰이름", "쿠폰종류", "쿠폰할인율", "쿠폰유효개월수"
             , TO_CHAR("쿠폰발행일", 'YYYY-MM-DD') AS "쿠폰발행일", TO_CHAR("쿠폰만료일", 'YYYY-MM-DD') AS "쿠폰만료일"
             , TO_CHAR("쿠폰사용완료일", 'YYYY-MM-DD') AS "쿠폰사용완료일"
        FROM VW_COUPON_MANAGEMENT
        WHERE "회원코드" = #{user_code}  AND "쿠폰만료일" > SYSDATE
        ORDER BY "쿠폰만료일" DESC
    </select>

    <!-- 해당 유저가 가진 유효한 쿠폰 개수 -->
    <select id="countValidCouponByUserCode" resultType="Integer">
        SELECT COUNT(*) AS COUPON_COUNT
        FROM VW_COUPON_MANAGEMENT
        WHERE "회원코드" = #{user_code} AND "쿠폰만료일" > SYSDATE
    </select>

</mapper>