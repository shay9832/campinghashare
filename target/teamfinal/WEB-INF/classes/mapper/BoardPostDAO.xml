<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IBoardPostDAO">
    <resultMap id="boardPostResultMap" type="com.team.mvc.DTO.BoardPostDTO">
        <result column="게시물ID" property="postId"/>
        <result column="회원닉네임" property="nickName"/>
        <result column="게시판카테고리" property="boardCategory"/>
        <result column="말머리이름" property="postLabelName"/>
        <result column="게시물제목" property="postTitle"/>
        <result column="게시물내용" property="postContent"/>
        <result column="게시물생성일" property="createdDate"/>
        <result column="게시판이름" property="boardName"/>
        <result column="게시물조회수" property="viewCount"/>
        <result column="추천수" property="recommendCount"/>
        <result column="댓글수" property="replyCount"/>
        <result column="인기글지정여부" property="isHot"/>
        <result column="블라인드여부" property="isBlinded"/>
    </resultMap>

    <!-- 게시물 전체 수 조회 (인기글 포함) -->
    <select id="getTotalPostCount" parameterType="com.team.mvc.DTO.BoardPostDTO" resultType="int">
        SELECT COUNT(*)
        FROM VW_POST_MANAGEMENT
        <where>
            "게시판이름" = (SELECT BOARD_NAME
                          FROM BOARD
                          WHERE BOARD_ID = #{boardId})
            AND "게시판이름" != '공지사항'
            AND "블라인드여부" = 0
            <if test="postLabelId = 0">
                AND "말머리이름" = (SELECT POST_LABEL_NAME
                                  FROM POST_LABEL
                                  WHERE POST_LABEL_ID = #{postLabelId})
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND "게시물내용" LIKE '%' || ${searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'writer'">
                        AND "회원닉네임" LIKE '%' || ${searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'titlecontent'">
                        AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                        OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <!-- 공지사항 조회 (최대 3개) -->
    <select id="listNotice" resultMap="boardPostResultMap">
        SELECT *
        FROM (
            SELECT *
            FROM VW_POST_MANAGEMENT
            WHERE "게시판이름" = '공지사항'
            AND "블라인드여부" = 0
            ORDER BY "게시물생성일" DESC
             )
        WHERE ROWNUM &lt;= 3
    </select>

    <!-- 인기글 조회 (특정 게시판의 최대 3개) -->
    <select id="listHotPost" parameterType="int" resultMap="boardPostResultMap">
        SELECT *
        FROM (
            SELECT *
            FROM VW_POST_MANAGEMENT
            WHERE "게시판이름" = (SELECT BOARD_NAME
                                FROM BOARD
                                WHERE BOARD_ID = #{boardId})
            AND "인기글지정여부" = 1
            AND "블라인드여부" = 0
            ORDER BY "게시물생성일" DESC
             )
        WHERE ROWNUM &lt;= 3
    </select>


    <select id="listPostList" parameterType="com.team.mvc.DTO.BoardPostDTO" resultMap="boardPostResultMap">
        SELECT *
        FROM (
        SELECT ROWNUM AS RNUM, A.*
        FROM (
        SELECT *
        FROM VW_POST_MANAGEMENT
        <where>
            "게시판이름" = (SELECT BOARD_NAME FROM BOARD WHERE BOARD_ID = #{boardId})
            AND "게시판이름" != '공지사항'
            AND "블라인드여부" = 0
            <if test="postLabelId != 0">
                AND "말머리이름" = (SELECT POST_LABEL_NAME FROM POST_LABEL WHERE POST_LABEL_ID = #{postLabelId})
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'writer'">
                        AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'titlecontent'">
                        AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                        OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY "게시물생성일" DESC
        ) A
        WHERE ROWNUM &lt;= #{pagenation.endRow}
        )
        WHERE RNUM >= #{pagenation.startRow}
    </select>

    <!-- 특정 게시물 조회 -->
    <select id="getPostById" parameterType="com.team.mvc.DTO.BoardPostDTO" resultMap="boardPostResultMap">
        SELECT *
        FROM VW_POST_MANAGEMENT
        WHERE "게시물ID" = #{postId}
    </select>

    <!-- 게시물 등록 -->
    <insert id="insertPost" parameterType="com.team.mvc.DTO.BoardPostDTO">
        INSERT INTO POST (
            POST_ID, USER_CODE, BOARD_ID, POST_LABEL_ID,
            POST_TITLE, POST_CONTENT, CREATED_DATE
        ) VALUES (
                     POST_SEQ.NEXTVAL, #{userCode}, #{boardId}, #{postLabelId},
                     #{postTitle}, #{postContent}, SYSDATE
                 )
    </insert>

    <!-- 게시물 수정 -->
    <update id="updatePost" parameterType="com.team.mvc.DTO.BoardPostDTO">
        UPDATE POST
        SET POST_TITLE = #{postTitle},
            POST_CONTENT = #{postContent},
            POST_LABEL_ID = #{postLabelId}
        WHERE POST_ID = #{postId}
    </update>

    <!-- 게시물 삭제 -->
    <delete id="deletePost" parameterType="com.team.mvc.DTO.BoardPostDTO">
        DELETE FROM POST
        WHERE POST_ID = #{postId}
    </delete>
</mapper>