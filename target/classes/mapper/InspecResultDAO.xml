<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IInspecResultDAO">

    <resultMap id="inspecResultMap" type="com.team.mvc.DTO.InspecResultDTO">
        <result column="CATEGORY_NAME" property="equipmentCategory"/>
        <result column="SUBCATEGORY_NAME" property="equipmentSubCategory"/>
        <result column="BRAND_NAME" property="brand"/>
        <result column="EQUIP_NAME" property="equipmentName"/>
        <result column="EQUIP_SIZE_NAME" property="equipmentSize"/>
        <result column="STOREN_ID" property="storenId"/>
        <result column="INSPECTION_DATE" property="inspectionDate"/>
        <result column="EQUIP_GRADE_NAME" property="equipmentGrade"/>
        <result column="INSPEC_ITEM_NAME" property="inspecItemName"/>
        <result column="INSPEC_COMMENT" property="inspectComment"/>
        <result column="INSPEC_GRADE_NAME" property="inspectResult"/>
        <result column="INSPEC_GRADE_DEDUCTION" property="inspecGradeDeduction"/>
        <result column="INSPEC_ITEM_DESC_HIGH" property="inspecItemDescHigh"/>
        <result column="INSPEC_ITEM_DESC_MID" property="inspecItemDescMid"/>
        <result column="INSPEC_ITEM_DESC_LOW" property="inspecItemDescLow"/>
        <result column="INSPEC_TYPE" property="inspecType"/>
        <result column="EQUIP_CODE" property="equipCode"/>
        <result column="TOTAL_SCORE" property="totalScore"/>
    </resultMap>

    <select id="getResultListByStorenId" resultMap="inspecResultMap">
        SELECT * FROM (
                          -- 1차검수
                          SELECT
                              C.CATEGORY_NAME,
                              PC.CATEGORY_NAME AS SUBCATEGORY_NAME,
                              B.BRAND_NAME,
                              EN.EQUIP_NAME,
                              ES.EQUIP_SIZE_NAME,
                              S.STOREN_ID,
                              TO_CHAR(IL.INSPECTION_DATE, 'YYYY-MM-DD') AS INSPECTION_DATE,
                              EG.EQUIP_GRADE_NAME,
                              II.INSPEC_ITEM_NAME,
                              IL.INSPEC_COMMENT,
                              IG.INSPEC_GRADE_NAME,
                              IG.INSPEC_GRADE_DEDUCTION,
                              II.INSPEC_ITEM_DESC_HIGH,
                              II.INSPEC_ITEM_DESC_MID,
                              II.INSPEC_ITEM_DESC_LOW,
                              '1차검수' AS INSPEC_TYPE,
                              EC.EQUIP_CODE,
                              100 - SUM(IG.INSPEC_GRADE_DEDUCTION) OVER (PARTITION BY S.STOREN_ID, PD.PLATFORM_DELIVERY_ID) AS TOTAL_SCORE
                          FROM STOREN S
                                   JOIN EQUIP_CODE EC ON S.EQUIP_CODE = EC.EQUIP_CODE
                                   JOIN EQUIPMENT_REGISTRATION ER ON EC.EQUIP_CODE = ER.EQUIP_CODE
                                   JOIN CATEGORY C ON ER.CATEGORY_ID = C.CATEGORY_ID
                                   LEFT JOIN CATEGORY PC ON C.PARENT_CATEGORY_ID = PC.CATEGORY_ID
                                   JOIN EQUIP_NAME EN ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                                   JOIN BRAND B ON EN.BRAND_ID = B.BRAND_ID
                                   JOIN EQUIP_SIZE ES ON S.SIZE_ID = ES.EQUIP_SIZE_ID
                                   JOIN PAY P ON S.STOREN_ID = P.STOREN_ID
                                   JOIN PLATFORM_DELIVERY PD ON P.PAY_ID = PD.PAY_ID
                                   JOIN INSPEC_LIST IL ON PD.PLATFORM_DELIVERY_ID = IL.PLATFORM_DELIVERY_ID
                                   JOIN INSPEC_RESULT IR ON IR.PLATFORM_DELIVERY_ID = PD.PLATFORM_DELIVERY_ID
                                   JOIN EQUIP_GRADE EG ON IR.EQUIP_GRADE_ID = EG.EQUIP_GRADE_ID
                                   LEFT JOIN CATE_INSPEC CI ON IL.CATE_INSPEC_ID = CI.CATE_INSPEC_ID
                                   LEFT JOIN INSPEC_ITEM II ON CI.INSPEC_ITEM_ID = II.INSPEC_ITEM_ID
                                   LEFT JOIN INSPEC_GRADE IG ON IL.INSPEC_GRADE_ID = IG.INSPEC_GRADE_ID
                          WHERE S.STOREN_ID = #{storen_id}

                          UNION ALL

                          -- 2차검수
                          SELECT
                              C.CATEGORY_NAME,
                              PC.CATEGORY_NAME AS SUBCATEGORY_NAME,
                              B.BRAND_NAME,
                              EN.EQUIP_NAME,
                              ES.EQUIP_SIZE_NAME,
                              S.STOREN_ID,
                              TO_CHAR(IL.INSPECTION_DATE, 'YYYY-MM-DD') AS INSPECTION_DATE,
                              EG.EQUIP_GRADE_NAME,
                              II.INSPEC_ITEM_NAME,
                              IL.INSPEC_COMMENT,
                              IG.INSPEC_GRADE_NAME,
                              IG.INSPEC_GRADE_DEDUCTION,
                              II.INSPEC_ITEM_DESC_HIGH,
                              II.INSPEC_ITEM_DESC_MID,
                              II.INSPEC_ITEM_DESC_LOW,
                              '2차검수' AS INSPEC_TYPE,
                              EC.EQUIP_CODE,
                              100 - SUM(IG.INSPEC_GRADE_DEDUCTION) OVER (PARTITION BY S.STOREN_ID, PDR.PLATFORM_DELIVERY_RETURN_ID) AS TOTAL_SCORE
                          FROM STOREN S
                                   JOIN EQUIP_CODE EC ON S.EQUIP_CODE = EC.EQUIP_CODE
                                   JOIN EQUIPMENT_REGISTRATION ER ON EC.EQUIP_CODE = ER.EQUIP_CODE
                                   JOIN CATEGORY C ON ER.CATEGORY_ID = C.CATEGORY_ID
                                   LEFT JOIN CATEGORY PC ON C.PARENT_CATEGORY_ID = PC.CATEGORY_ID
                                   JOIN EQUIP_NAME EN ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                                   JOIN BRAND B ON EN.BRAND_ID = B.BRAND_ID
                                   JOIN EQUIP_SIZE ES ON S.SIZE_ID = ES.EQUIP_SIZE_ID
                                   JOIN PAY P ON S.STOREN_ID = P.STOREN_ID
                                   JOIN PLATFORM_DELIVERY PD ON P.PAY_ID = PD.PAY_ID
                                   JOIN PLATFORM_DELIVERY_RETURN PDR ON PD.PLATFORM_DELIVERY_ID = PDR.PLATFORM_DELIVERY_ID
                                   JOIN INSPEC_LIST IL ON PDR.PLATFORM_DELIVERY_RETURN_ID = IL.PLATFORM_DELIVERY_RETURN_ID
                                   JOIN INSPEC_RESULT IR ON IR.PLATFORM_DELIVERY_RETURN_ID = PDR.PLATFORM_DELIVERY_RETURN_ID
                                   JOIN EQUIP_GRADE EG ON IR.EQUIP_GRADE_ID = EG.EQUIP_GRADE_ID
                                   LEFT JOIN CATE_INSPEC CI ON IL.CATE_INSPEC_ID = CI.CATE_INSPEC_ID
                                   LEFT JOIN INSPEC_ITEM II ON CI.INSPEC_ITEM_ID = II.INSPEC_ITEM_ID
                                   LEFT JOIN INSPEC_GRADE IG ON IL.INSPEC_GRADE_ID = IG.INSPEC_GRADE_ID
                          WHERE S.STOREN_ID = #{storen_id}
                      )
        ORDER BY INSPECTION_DATE, INSPEC_ITEM_NAME
    </select>
</mapper>
