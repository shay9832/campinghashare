<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IBoardPostDAO">
    <resultMap id="boardPostResultMap" type="com.team.mvc.DTO.BoardPostDTO">
        <result column="게시물ID" property="postId"/>
        <result property="rowNum" column="RNUM"/>
        <result column="USER_CODE" property="userCode"/>
        <result column="회원닉네임" property="nickName"/>
        <result column="게시판카테고리" property="boardCategory"/>
        <result column="말머리이름" property="postLabelName"/>
        <result column="게시물제목" property="postTitle"/>
        <result column="게시물내용" property="postContent"/>
        <result column="게시물생성일" property="createdDate"/>
        <result column="게시판이름" property="boardName"/>
        <result column="게시물조회수" property="viewCount"/>
        <result column="추천수" property="recommendCount"/>
        <result column="댓글수" property="replyCount"/>
        <result column="인기글지정여부" property="isHot"/>
        <result column="블라인드여부" property="isBlinded"/>
    </resultMap>

    <!-- 첨부파일을 포함한 게시글 정보를 위한 resultMap -->
    <resultMap id="boardPostWithAttachmentsResultMap" type="com.team.mvc.DTO.BoardPostDTO" extends="boardPostResultMap">
        <collection property="attachments" ofType="com.team.mvc.DTO.AttachmentDTO">
            <id column="ATTACHMENT_ID" property="attachmentPostId"/>
            <result column="ATTACHMENT_NAME" property="attachmentName"/>
            <result column="ATTACHMENT_PATH" property="attachmentPath"/>
            <result column="ATTACHMENT_SIZE" property="attachmentSize"/>
            <result column="ATTACHMENT_ORDER" property="attachmentOrder"/>
        </collection>
    </resultMap>

    <!-- 게시판 아이디, 이름 조회 -->
    <select id="getBoardByName" parameterType="string" resultType="com.team.mvc.DTO.BoardDTO">
        SELECT BOARD_ID as boardId,
               BOARD_NAME as boardName
        FROM BOARD
        WHERE BOARD_NAME = #{boardName}
    </select>

    <!-- 게시물 전체 수 조회 (인기글 포함) -->
    <select id="getTotalPostCount" parameterType="com.team.mvc.DTO.BoardPostDTO" resultType="int">
        SELECT COUNT(*)
        FROM VW_POST_MANAGEMENT
        <where>
            "게시판이름" = (SELECT BOARD_NAME
            FROM BOARD
            WHERE BOARD_ID = #{boardId})
            AND "게시판이름" != '공지사항'
            AND "블라인드여부" = 0
            <if test="postLabelId != null">
                AND "말머리이름" = (SELECT POST_LABEL_NAME
                FROM POST_LABEL
                WHERE POST_LABEL_ID = #{postLabelId,jdbcType=INTEGER})
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'writer'">
                        AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'titlecontent'">
                        AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                        OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <!-- 게시판별 게시물 목록 조회 (인기글포함) -->
    <select id="listPostList" parameterType="com.team.mvc.DTO.BoardPostDTO" resultMap="boardPostWithAttachmentsResultMap">
        SELECT *
        FROM (
        SELECT ROWNUM AS RNUM, A.*
        FROM (
        SELECT *
        FROM VW_POST_MANAGEMENT
        <where>
            "게시판이름" = (SELECT BOARD_NAME FROM BOARD WHERE BOARD_ID = #{boardId})
            AND "게시판이름" != '공지사항'
            AND "블라인드여부" = 0
            <if test="postLabelId != null">
                AND "말머리이름" = (SELECT POST_LABEL_NAME FROM POST_LABEL WHERE POST_LABEL_ID = #{postLabelId,jdbcType=INTEGER})
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'writer'">
                        AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'titlecontent'">
                        AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                        OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sortType == 'views'">게시물조회수 DESC</when>
            <when test="sortType == 'recommends'">추천수 DESC</when>
            <otherwise>게시물생성일 DESC</otherwise>
        </choose>
        ) A
        WHERE ROWNUM &lt;= #{pagenation.endRow}
        )
        WHERE RNUM >= #{pagenation.startRow}
    </select>


    <!-- 전체 인기글 조회 -->
    <select id="listTotalHotPost" resultMap="boardPostResultMap">
        SELECT *
        FROM VW_POST_MANAGEMENT
        WHERE "인기글지정여부" = 1
          AND "블라인드여부" = 0
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'content'">
                    AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'writer'">
                    AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'titlecontent'">
                    AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                </when>
            </choose>
        </if>
        ORDER BY
        <choose>
            <when test="sortType == 'views'">"게시물조회수" DESC</when>
            <when test="sortType == 'recommends'">"추천수" DESC</when>
            <otherwise>"게시물생성일" DESC</otherwise>
        </choose>
    </select>


    <!-- 전체 인기글 중 최신 N개 조회 (첨부파일 포함) -->
    <select id="listBestPosts" parameterType="map" resultMap="boardPostWithAttachmentsResultMap">
        SELECT P.*,
               AP.ATTACHMENT_POST_ID as ATTACHMENT_ID,
               AP.ATTACHMENT_NAME,
               AP.ATTACHMENT_PATH,
               AP.ATTACHMENT_SIZE,
               AP.ATTACHMENT_ORDER
        FROM (SELECT *
              FROM VW_POST_MANAGEMENT
              WHERE "인기글지정여부" = 1
                AND "블라인드여부" = 0
              ORDER BY "게시물생성일" DESC) P
                 LEFT JOIN ATTACHMENT_POST AP ON P."게시물ID" = AP.POST_ID
        WHERE ROWNUM &lt;= #{limit}
        ORDER BY P."게시물생성일" DESC, AP.ATTACHMENT_ORDER ASC
    </select>

    <!-- 특정 게시판 인기글 중 최신 N개 조회 (첨부파일 포함) -->
    <select id="listBoardHotPosts" parameterType="map" resultMap="boardPostWithAttachmentsResultMap">
        SELECT P.*,
               AP.ATTACHMENT_POST_ID as ATTACHMENT_ID,
               AP.ATTACHMENT_NAME,
               AP.ATTACHMENT_PATH,
               AP.ATTACHMENT_SIZE,
               AP.ATTACHMENT_ORDER
        FROM (SELECT *
              FROM VW_POST_MANAGEMENT
              WHERE "게시판이름" = (SELECT BOARD_NAME
                               FROM BOARD
                               WHERE BOARD_ID = #{boardId})
                AND "인기글지정여부" = 1
                AND "블라인드여부" = 0
              ORDER BY "게시물생성일" DESC) P
                 LEFT JOIN ATTACHMENT_POST AP ON P."게시물ID" = AP.POST_ID
        WHERE ROWNUM &lt;= #{limit}
        ORDER BY P."게시물생성일" DESC, AP.ATTACHMENT_ORDER ASC
    </select>

    <!-- 게시판 카테고리별 게시판 조회 -->
    <select id="getBoardsByCategoryId" parameterType="int" resultType="com.team.mvc.DTO.BoardDTO">
        SELECT BOARD_ID       as boardId,
               BOARD_CATE_ID  as boardCateId,
               WRITE_GRADE_ID as writeGradeId,
               BOARD_NAME     as boardName,
               BOARD_DESC     as boardDesc
        FROM BOARD
        WHERE BOARD_CATE_ID = #{boardCateId}
        ORDER BY BOARD_ID
    </select>

    <!-- 게시판별 말머리 조회 -->
    <select id="getPostLabelsByBoardId" parameterType="int" resultType="com.team.mvc.DTO.BoardPostDTO">
        SELECT
            POST_LABEL_ID as postLabelId,
            BOARD_ID as boardId,
            POST_LABEL_NAME as postLabelName
        FROM POST_LABEL
        WHERE BOARD_ID = #{boardId}
        ORDER BY POST_LABEL_ID
    </select>


    <!-- 인기글 전체 수 조회 -->
    <select id="getTotalHotPostCount" parameterType="com.team.mvc.DTO.BoardPostDTO" resultType="int">
        SELECT COUNT(*)
        FROM VW_POST_MANAGEMENT
        <where>
            "게시판이름" = (SELECT BOARD_NAME
            FROM BOARD
            WHERE BOARD_ID = #{boardId})
            AND "인기글지정여부" = 1
            AND "블라인드여부" = 0
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'writer'">
                        AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'titlecontent'">
                        AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                        OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <!-- 인기글 목록 조회 (전체 게시글의 번호를 유지) -->
    <select id="listHotPostsWithRownum" parameterType="com.team.mvc.DTO.BoardPostDTO" resultMap="boardPostResultMap">
        SELECT
        hotposts.*,
        (SELECT COUNT(*)
        FROM VW_POST_MANAGEMENT
        WHERE "게시판이름" = (SELECT BOARD_NAME FROM BOARD WHERE BOARD_ID = #{boardId})
        AND "게시판이름" != '공지사항'
        AND "블라인드여부" = 0) - hotposts.ROWNUMBER + 1 AS RNUM
        FROM (
        SELECT
        A.*,
        ROWNUM AS ROWNUMBER
        FROM (
        SELECT *
        FROM VW_POST_MANAGEMENT
        WHERE "게시판이름" = (SELECT BOARD_NAME FROM BOARD WHERE BOARD_ID = #{boardId})
        AND "게시판이름" != '공지사항'
        AND "인기글지정여부" = 1
        AND "블라인드여부" = 0
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'content'">
                    AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'writer'">
                    AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'titlecontent'">
                    AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                </when>
            </choose>
        </if>
        ORDER BY "게시물생성일" DESC
        ) A
        WHERE ROWNUM &lt;= #{pagenation.endRow}
        ) hotposts
        WHERE ROWNUMBER >= #{pagenation.startRow}
    </select>

    <!-- 전체 공지사항 조회   -->
    <select id="listTotalNotice" resultMap="boardPostResultMap" parameterType="com.team.mvc.DTO.BoardPostDTO">
        SELECT *
        FROM VW_POST_MANAGEMENT
        WHERE "게시판이름" = '공지사항'
          AND "블라인드여부" = 0
        <if test="postLabelId != null">
            AND "말머리이름" = (SELECT POST_LABEL_NAME
            FROM POST_LABEL
            WHERE POST_LABEL_ID = #{postLabelId,jdbcType=INTEGER})
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'content'">
                    AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'writer'">
                    AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'titlecontent'">
                    AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                </when>
            </choose>
        </if>
        ORDER BY
        <choose>
            <when test="sortType == 'views'">게시물조회수 DESC</when>
            <when test="sortType == 'recommends'">추천수 DESC</when>
            <otherwise>게시물생성일 DESC</otherwise>
        </choose>
    </select>


    <!-- 공지사항 조회 (최대 3개) -->
    <select id="listNotice" resultMap="boardPostResultMap">
        SELECT *
        FROM (SELECT *
              FROM VW_POST_MANAGEMENT
              WHERE "게시판이름" = '공지사항'
                AND "블라인드여부" = 0
              ORDER BY "게시물생성일" DESC)
        WHERE ROWNUM &lt;= 3
    </select>

    <!-- 공지사항 전체 게시물 수 -->
    <select id="getTotalNoticeCount" parameterType="com.team.mvc.DTO.BoardPostDTO" resultType="int">
        SELECT COUNT(*)
        FROM VW_POST_MANAGEMENT
        WHERE "게시판이름" = '공지사항'
        AND "블라인드여부" = 0
        <if test="postLabelId != null">
            AND "말머리이름" = (SELECT POST_LABEL_NAME
            FROM POST_LABEL
            WHERE POST_LABEL_ID = #{postLabelId,jdbcType=INTEGER})
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'content'">
                    AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'writer'">
                    AND "회원닉네임" LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'titlecontent'">
                    AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                </when>
            </choose>
        </if>
    </select>


    <!-- 게시판 ID로 게시판 정보 조회 -->
    <select id="getBoardById" parameterType="int" resultType="com.team.mvc.DTO.BoardDTO">
        SELECT BOARD_ID as boardId,
               BOARD_CATE_ID as boardCateId,
               WRITE_GRADE_ID as writeGradeId,
               BOARD_NAME as boardName,
               BOARD_DESC as boardDesc
        FROM BOARD
        WHERE BOARD_ID = #{boardId}
    </select>

    <!-- 특정 게시물 조회 -->
    <select id="getPostById" parameterType="com.team.mvc.DTO.BoardPostDTO" resultMap="boardPostResultMap">
        SELECT V.*, P.USER_CODE AS USER_CODE
        FROM VW_POST_MANAGEMENT V
        JOIN POST P ON V."게시물ID" = P.POST_ID
        WHERE "게시물ID" = #{postId}
    </select>

    <!-- 게시글 조회수 증가 로그 추가 -->
    <insert id="insertPostViewLog" parameterType="com.team.mvc.DTO.PostViewLogDTO">
        INSERT INTO POST_VIEW_LOG (
            POST_VIEW_LOG_ID, USER_CODE, POST_ID, CREATED_DATE
        ) VALUES (
                     POST_VIEW_LOG_SEQ.NEXTVAL, #{userCode}, #{postId}, SYSDATE
                 )
    </insert>

    <!-- 게시글 첨부파일 목록 조회 -->
    <select id="getAttachmentsByPostId" parameterType="int" resultType="com.team.mvc.DTO.AttachmentDTO">
        SELECT
            ATTACHMENT_POST_ID as attachmentPostId,
            POST_ID as postId,
            ATTACHMENT_NAME as attachmentName,
            ATTACHMENT_PATH as attachmentPath,
            ATTACHMENT_SIZE as attachmentSize,
            ATTACHMENT_ORDER as attachmentOrder,
            CREATED_DATE as createdDate
        FROM ATTACHMENT_POST
        WHERE POST_ID = #{postId}
        ORDER BY ATTACHMENT_ORDER ASC
    </select>

    <!-- 게시글 댓글 목록 조회 -->
    <select id="getRepliesByPostId" parameterType="int" resultType="com.team.mvc.DTO.ReplyDTO">
        SELECT
            R.REPLY_ID as replyId,
            R.ROOT_REPLY_ID as rootReplyId,
            R.USER_CODE as userCode,
            R.POST_ID as postId,
            R.REPLY_CONTENT as replyContent,
            R.CREATED_DATE as createdDate,
            -- 닉네임을 함께 조회
            (SELECT NICKNAME
             FROM NICKNAME_LOG
             WHERE USER_CODE = R.USER_CODE
               AND LAST_UPDATED_DATE = (SELECT MAX(LAST_UPDATED_DATE)
                                        FROM NICKNAME_LOG
                                        WHERE USER_CODE = R.USER_CODE)) as nickname
        FROM REPLY R
        WHERE R.POST_ID = #{postId}
        ORDER BY
            CASE WHEN R.ROOT_REPLY_ID IS NULL THEN R.REPLY_ID ELSE R.ROOT_REPLY_ID END ASC,
            R.CREATED_DATE ASC
    </select>

    <!-- 이전 게시글 ID 조회 -->
    <select id="getPrevPostId" parameterType="map" resultType="java.lang.Integer">
        SELECT MAX(POST_ID)
        FROM POST
        WHERE POST_ID &lt; #{postId}
          AND BOARD_ID = #{boardId}
    </select>

    <!-- 다음 게시글 ID 조회 -->
    <select id="getNextPostId" parameterType="map" resultType="java.lang.Integer">
        SELECT MIN(POST_ID)
        FROM POST
        WHERE POST_ID &gt; #{postId}
          AND BOARD_ID = #{boardId}
    </select>


    <!-- 게시물 등록 -->
    <insert id="insertPost" parameterType="com.team.mvc.DTO.BoardPostDTO" useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO POST (POST_ID, USER_CODE, BOARD_ID, POST_LABEL_ID,
                          POST_TITLE, POST_CONTENT, CREATED_DATE)
        VALUES (POST_SEQ.NEXTVAL, #{userCode}, #{boardId}, #{postLabelId,jdbcType=INTEGER},
                #{postTitle}, #{postContent}, SYSDATE)
        <selectKey keyProperty="postId" resultType="int" order="AFTER">
            SELECT POST_SEQ.currval FROM DUAL
        </selectKey>
    </insert>

    <!-- 게시물 수정 -->
    <update id="updatePost" parameterType="com.team.mvc.DTO.BoardPostDTO">
        UPDATE POST
        SET POST_TITLE    = #{postTitle},
            POST_CONTENT  = #{postContent},
            POST_LABEL_ID = #{postLabelId,jdbcType=INTEGER}
        WHERE POST_ID = #{postId}
    </update>

    <!-- 게시물 삭제 -->
    <delete id="deletePost" parameterType="com.team.mvc.DTO.BoardPostDTO">
        DELETE
        FROM POST
        WHERE POST_ID = #{postId}
    </delete>


    <!-- 추천 여부 확인 -->
    <select id="checkRecommend" parameterType="com.team.mvc.DTO.BoardPostDTO" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM RECOMMEND
        WHERE POST_ID = #{postId} AND USER_CODE = #{userCode}
    </select>

    <!-- 추천 추가 -->
    <insert id="insertRecommend" parameterType="com.team.mvc.DTO.BoardPostDTO">
        INSERT INTO RECOMMEND (RECOMMEND_ID, POST_ID, USER_CODE, CREATED_DATE)
        VALUES (RECOMMEND_SEQ.NEXTVAL, #{postId}, #{userCode}, SYSDATE)
    </insert>

    <!-- 게시글 추천 수 조회 -->
    <select id="getRecommendCount" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM RECOMMEND
        WHERE POST_ID = #{postId}
    </select>

    <!-- HOT_POST_LOG 테이블에 로그 추가 -->
    <insert id="insertHotPostLog" parameterType="com.team.mvc.DTO.BoardPostDTO">
        INSERT INTO HOT_POST_LOG (HOT_POST_LOG_ID, POST_ID, CREATED_DATE)
        SELECT HOT_POST_LOG_SEQ.nextval, #{postId}, SYSDATE
        FROM DUAL
        WHERE NOT EXISTS (SELECT 1
                          FROM HOT_POST_LOG
                          WHERE POST_ID = #{postId})
    </insert>

    <!-- 첨부파일 등록 -->
    <insert id="insertAttachment" parameterType="com.team.mvc.DTO.AttachmentDTO">
        INSERT INTO ATTACHMENT_POST (ATTACHMENT_POST_ID, POST_ID, ATTACHMENT_NAME, ATTACHMENT_PATH, ATTACHMENT_SIZE, ATTACHMENT_ORDER, CREATED_DATE)
        VALUES (ATTACHMENT_POST_SEQ.nextval, #{postId}, #{attachmentName}, #{attachmentPath}, #{attachmentSize}, #{attachmentOrder}, SYSDATE)
    </insert>

    <!-- 첨부파일 삭제 -->
    <delete id="deleteAttachment" parameterType="com.team.mvc.DTO.AttachmentDTO">
        DELETE
        FROM ATTACHMENT_POST
        WHERE ATTACHMENT_POST_ID = #{attachmentPostId}
    </delete>

    <!-- 북마크 추가 -->
    <insert id="insertBookmark" parameterType="com.team.mvc.DTO.BoardPostDTO">
        INSERT INTO BOOKMARK (BOOKMARK_ID, USER_CODE, POST_ID, CREATED_DATE)
        VALUES (BOOKMARK_SEQ.nextval, #{userCode}, #{postId}, SYSDATE)
    </insert>

    <!-- 북마크 제거 -->
    <delete id="deleteBookmark" parameterType="com.team.mvc.DTO.BoardPostDTO">
        DELETE
        FROM BOOKMARK
        WHERE USER_CODE = #{userCode} AND POST_ID = #{postId}
    </delete>
    
    <!-- 북마크 여부 -->
    <select id="checkBookmark" parameterType="com.team.mvc.DTO.BoardPostDTO" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM BOOKMARK
        WHERE POST_ID = #{postId} AND USER_CODE = #{userCode}
    </select>

    <!-- 게시글 ID로 북마크 삭제 -->
    <delete id="deleteBookmarksByPostId" parameterType="int">
        DELETE FROM BOOKMARK WHERE POST_ID = #{postId}
    </delete>

    <!-- 게시글 ID로 추천 삭제 -->
    <delete id="deleteRecommendsByPostId" parameterType="int">
        DELETE FROM RECOMMEND WHERE POST_ID = #{postId}
    </delete>


    <!-- 유저코드로 해당 유저가 작성한 게시물 조회(최근등록순 5건까지) -->
    <select id="listRecentPostByUserCode" resultMap="boardPostResultMap">
        SELECT *
        FROM (
        SELECT *
        FROM VW_POST_MANAGEMENT
        WHERE USER_CODE = #{userCode}
        ORDER BY "게시물생성일" DESC
        )
        <![CDATA[WHERE ROWNUM <= ${count}]]>
    </select>

    <!-- int타입 post_id로 특정 게시물 조회 -->
    <select id="getPostByPostId" resultMap="boardPostResultMap">
        select *
        from vw_post_management
        where "게시물ID" = #{postId}
    </select>

    <!-- 사용자가 작성한 게시글 전체 수 조회 -->
    <select id="getUserPostCount" parameterType="com.team.mvc.DTO.BoardPostDTO" resultType="int">
        SELECT COUNT(*)
        FROM VW_POST_MANAGEMENT
        <where>
            USER_CODE = #{userCode}
            AND "블라인드여부" = 0
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND "게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND "게시물내용" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'titlecontent'">
                        AND ("게시물제목" LIKE '%' || #{searchKeyword} || '%'
                        OR "게시물내용" LIKE '%' || #{searchKeyword} || '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <!-- 사용자가 작성한 게시글 목록 조회 (페이징 처리) -->
    <select id="listUserPostByDTO" parameterType="com.team.mvc.DTO.BoardPostDTO" resultMap="boardPostWithAttachmentsResultMap">
        SELECT *
        FROM (
        SELECT ROWNUM AS RNUM, A.*
        FROM (
        SELECT P.*,
        AP.ATTACHMENT_POST_ID as ATTACHMENT_ID,
        AP.ATTACHMENT_NAME,
        AP.ATTACHMENT_PATH,
        AP.ATTACHMENT_SIZE,
        AP.ATTACHMENT_ORDER
        FROM VW_POST_MANAGEMENT P
        LEFT JOIN ATTACHMENT_POST AP ON P."게시물ID" = AP.POST_ID
        <where>
            P.USER_CODE = #{userCode}
            AND P."블라인드여부" = 0
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND P."게시물제목" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND P."게시물내용" LIKE '%' || #{searchKeyword} || '%'
                    </when>
                    <when test="searchType == 'titlecontent'">
                        AND (P."게시물제목" LIKE '%' || #{searchKeyword} || '%'
                        OR P."게시물내용" LIKE '%' || #{searchKeyword} || '%')
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sortType == 'views'">P."게시물조회수" DESC</when>
            <when test="sortType == 'recommends'">P."추천수" DESC</when>
            <otherwise>P."게시물생성일" DESC</otherwise>
        </choose>
        ) A
        WHERE ROWNUM &lt;= #{pagenation.endRow}
        )
        WHERE RNUM >= #{pagenation.startRow}
        ORDER BY "게시물생성일" DESC, ATTACHMENT_ORDER ASC
    </select>
</mapper>