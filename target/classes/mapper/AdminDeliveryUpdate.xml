<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IAdminDeliveryUpdateDAO">

    <!-- 배송 정보 결과 매핑 -->
    <resultMap id="deliveryResultMap" type="com.team.mvc.DTO.AdminDeliveryUpdateDTO">
        <result property="deliveryType" column="배송종류" />
        <result property="senderId" column="발송인" />
        <result property="receiverId" column="수취인" />
        <result property="storenId" column="스토렌ID" />
        <result property="storageId" column="보관ID" />
        <result property="rentalMatchingDoneId" column="렌탈매칭완료ID" />
        <result property="rentalId" column="렌탈ID" />
        <result property="deliveryId" column="배송ID" />
        <result property="equipmentName" column="장비명" />
        <result property="carrierName" column="운송사이름" />
        <result property="waybillNumber" column="운송장번호" />
        <result property="deliveryStartDate" column="배송시작일" />
        <result property="deliveryEndDate" column="배송종료일" />
        <result property="inspectionCompletedDate" column="검수결과처리일" />
        <result property="inspectionResultType" column="검수결과처리유형" />
        <result property="platformDeliveryReturnId" column="PLATFORM_DELIVERY_RETURN_ID"/>
        <result property="platformDeliveryId" column="PLATFORM_DELIVERY_ID"/>
        <!-- 렌탈 날짜 필드 추가 -->
        <result property="rentalStartDate" column="렌탈시작일" />
        <result property="rentalEndDate" column="렌탈종료일" />
    </resultMap>

    <!-- 기본 조회 쿼리 -->
    <sql id="baseDeliveryQuery">
        SELECT
            '스토렌_최초입고'                          AS "배송종류"
             , ER.USER_CODE                              AS "발송인"
             , -1                                        AS "수취인"
             , S.STOREN_ID                               AS "스토렌ID"
             , P.STORAGE_ID                              AS "보관ID"
             , P.RENTAL_MATCHING_DONE_ID                 AS "렌탈매칭완료ID"
             , NULL                                      AS "렌탈ID"
             , PD.PLATFORM_DELIVERY_ID                   AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , NULL                                      AS "운송사이름"
             , NULL                                      AS "운송장번호"
             , PD.DELIVERY_START_DATE                    AS "배송시작일"
             , PD.DELIVERY_END_DATE                      AS "배송종료일"
             , IRA.COMPLETED_DATE                        AS "검수결과처리일"
             , IRAT.INSPEC_RESULT_ACTION_TYPE_NAME       AS "검수결과처리유형"
             , NULL                                      AS "렌탈시작일"
             , NULL                                      AS "렌탈종료일"
        FROM PAY P
                 JOIN STOREN S
                      ON P.STOREN_ID = S.STOREN_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN PLATFORM_DELIVERY PD
                      ON P.PAY_ID = PD.PAY_ID
                 LEFT JOIN INSPEC_RESULT IR
                           ON IR.PLATFORM_DELIVERY_ID = PD.PLATFORM_DELIVERY_ID
                 LEFT JOIN INSPEC_RESULT_ACTION IRA
                           ON IRA.INSPEC_RESULT_ID = IR.INSPEC_RESULT_ID
                 LEFT JOIN INSPEC_RESULT_ACTION_TYPE IRAT
                           ON IRA.INSPEC_RESULT_ACTION_TYPE_ID = IRAT.INSPEC_RESULT_ACTION_TYPE_ID
        WHERE P.STOREN_ID IS NOT NULL

        UNION ALL

        -- 2. 보관 플랫폼배송최초입고
        SELECT
            '보관_최초입고'                            AS "배송종류"
             , ER.USER_CODE                              AS "발송인"
             , -1                                        AS "수취인"
             , P.STOREN_ID                               AS "스토렌ID"
             , S.STORAGE_ID                              AS "보관ID"
             , P.RENTAL_MATCHING_DONE_ID                 AS "렌탈매칭완료ID"
             , NULL                                      AS "렌탈ID"
             , PD.PLATFORM_DELIVERY_ID                   AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , NULL                                      AS "운송사이름"
             , NULL                                      AS "운송장번호"
             , PD.DELIVERY_START_DATE                    AS "배송시작일"
             , PD.DELIVERY_END_DATE                      AS "배송종료일"
             , IRA.COMPLETED_DATE                        AS "검수결과처리일"
             , IRAT.INSPEC_RESULT_ACTION_TYPE_NAME       AS "검수결과처리유형"
             , NULL                                      AS "렌탈시작일"
             , NULL                                      AS "렌탈종료일"
        FROM PAY P
                 JOIN STORAGE S
                      ON P.STORAGE_ID = S.STORAGE_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN PLATFORM_DELIVERY PD
                      ON P.PAY_ID = PD.PAY_ID
                 LEFT JOIN INSPEC_RESULT IR
                           ON IR.PLATFORM_DELIVERY_ID = PD.PLATFORM_DELIVERY_ID
                 LEFT JOIN INSPEC_RESULT_ACTION IRA
                           ON IRA.INSPEC_RESULT_ID = IR.INSPEC_RESULT_ID
                 LEFT JOIN INSPEC_RESULT_ACTION_TYPE IRAT
                           ON IRA.INSPEC_RESULT_ACTION_TYPE_ID = IRAT.INSPEC_RESULT_ACTION_TYPE_ID
        WHERE P.STORAGE_ID IS NOT NULL

        UNION ALL

        -- 3. 렌탈_사용자배송_발송
        SELECT
            '렌탈_발송'                                AS "배송종류"
             , ER.USER_CODE                              AS "발송인"
             , RMR.RENTAL_MATCHING_REQUESTER_ID          AS "수취인"
             , P.STOREN_ID                               AS "스토렌ID"
             , P.STORAGE_ID                              AS "보관ID"
             , P.RENTAL_MATCHING_DONE_ID                 AS "렌탈매칭완료ID"
             , R.RENTAL_ID                               AS "렌탈ID"
             , UD.USERS_DELIVERY_ID                      AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , UD.CARRIER_NAME                           AS "운송사이름"
             , UD.WAYBILL_NUMBER                         AS "운송장번호"
             , UD.WAYBILL_ENTRY_DATE                     AS "배송시작일"
             , UD.DELIVERY_END_DATE                      AS "배송종료일"
             , NULL                                      AS "검수결과처리일"
             , NULL                                      AS "검수결과처리유형"
             , RMR.RENTAL_START_DATE                     AS "렌탈시작일"
             , RMR.RENTAL_END_DATE                       AS "렌탈종료일"
        FROM PAY P
                 JOIN RENTAL_MATCHING_DONE RMD
                      ON P.RENTAL_MATCHING_DONE_ID = RMD.RENTAL_MATCHING_DONE_ID
                 JOIN RENTAL_MATCHING_REQ RMR
                      ON RMD.RENTAL_MATCHING_REQ_ID = RMR.RENTAL_MATCHING_REQ_ID
                 JOIN RENTAL R
                      ON RMR.RENTAL_ID = R.RENTAL_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON R.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN USERS_DELIVERY UD
                      ON P.PAY_ID = UD.PAY_ID
        WHERE P.RENTAL_MATCHING_DONE_ID IS NOT NULL

        UNION ALL

        -- 4. 스토렌_플랫폼배송_발송
        SELECT
            '스토렌_매칭발송'                          AS "배송종류"
             , -1                                        AS "발송인"
             , SMR.STOREN_MATCHING_REQ_USER_ID           AS "수취인"
             , S.STOREN_ID                               AS "스토렌ID"
             , P.STORAGE_ID                              AS "보관ID"
             , P.STOREN_MATCHING_DONE_ID                 AS "렌탈매칭완료ID"
             , P.RENTAL_MATCHING_DONE_ID                 AS "렌탈ID"
             , PD.PLATFORM_DELIVERY_ID                   AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , NULL                                      AS "운송사이름"
             , NULL                                      AS "운송장번호"
             , PD.DELIVERY_START_DATE                    AS "배송시작일"
             , PD.DELIVERY_END_DATE                      AS "배송종료일"
             , IRA.COMPLETED_DATE                        AS "검수결과처리일"
             , IRAT.INSPEC_RESULT_ACTION_TYPE_NAME       AS "검수결과처리유형"
             , SMR.RENTAL_START_DATE                     AS "렌탈시작일"
             , SMR.RENTAL_END_DATE                       AS "렌탈종료일"
        FROM PAY P
                 JOIN STOREN_MATCHING_DONE SMD
                      ON P.STOREN_MATCHING_DONE_ID = SMD.STOREN_MATCHING_DONE_ID
                 JOIN STOREN_MATCHING_REQ SMR
                      ON SMD.STOREN_MATCHING_REQ_ID = SMR.STOREN_MATCHING_REQ_ID
                 JOIN STOREN_IRA SI
                      ON SMR.STOREN_IRA_ID = SI.STOREN_IRA_ID
                 JOIN STOREN S
                      ON SI.STOREN_ID = S.STOREN_ID
                 JOIN INSPEC_RESULT_ACTION IRA
                      ON SI.INSPEC_RESULT_ACTION_ID = IRA.INSPEC_RESULT_ACTION_ID
                 JOIN INSPEC_RESULT_ACTION_TYPE IRAT
                      ON IRA.INSPEC_RESULT_ACTION_TYPE_ID = IRAT.INSPEC_RESULT_ACTION_TYPE_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN PLATFORM_DELIVERY PD
                      ON P.PAY_ID = PD.PAY_ID
        WHERE P.STOREN_MATCHING_DONE_ID IS NOT NULL

        UNION ALL
        -- 5. 스토렌_플랫폼배송_반납
        SELECT
            '스토렌_매칭반납'                          AS "배송종류"
             , SMR.STOREN_MATCHING_REQ_USER_ID           AS "발송인"
             , -1                                        AS "수취인"
             , S.STOREN_ID                               AS "스토렌ID"
             , P.STORAGE_ID                              AS "보관ID"
             , P.STOREN_MATCHING_DONE_ID                 AS "렌탈매칭완료ID"
             , P.RENTAL_MATCHING_DONE_ID                 AS "렌탈ID"
             , PDR.PLATFORM_DELIVERY_RETURN_ID           AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , NULL                                      AS "운송사이름"
             , NULL                                      AS "운송장번호"
             , PDR.DELIVERY_START_DATE                   AS "배송시작일"
             , PDR.DELIVERY_END_DATE                     AS "배송종료일"
             , IRA.COMPLETED_DATE                        AS "검수결과처리일"
             , IRAT.INSPEC_RESULT_ACTION_TYPE_NAME       AS "검수결과처리유형"
             , SMR.RENTAL_START_DATE                     AS "렌탈시작일"
             , SMR.RENTAL_END_DATE                       AS "렌탈종료일"
        FROM PLATFORM_DELIVERY PD
                 JOIN PAY P
                      ON PD.PAY_ID = P.PAY_ID
                 JOIN STOREN_MATCHING_DONE SMD
                      ON P.STOREN_MATCHING_DONE_ID = SMD.STOREN_MATCHING_DONE_ID
                 JOIN STOREN_MATCHING_REQ SMR
                      ON SMD.STOREN_MATCHING_REQ_ID = SMR.STOREN_MATCHING_REQ_ID
                 JOIN STOREN_IRA SI
                      ON SMR.STOREN_IRA_ID = SI.STOREN_IRA_ID
                 JOIN STOREN S
                      ON SI.STOREN_ID = S.STOREN_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN PLATFORM_DELIVERY_RETURN PDR
                      ON PD.PLATFORM_DELIVERY_ID = PDR.PLATFORM_DELIVERY_ID
                 JOIN INSPEC_RESULT IR
                      ON PDR.PLATFORM_DELIVERY_RETURN_ID = IR.PLATFORM_DELIVERY_RETURN_ID
                 JOIN INSPEC_RESULT_ACTION IRA
                      ON IR.INSPEC_RESULT_ID = IRA.INSPEC_RESULT_ID
                 JOIN INSPEC_RESULT_ACTION_TYPE IRAT
                      ON IRA.INSPEC_RESULT_ACTION_TYPE_ID = IRAT.INSPEC_RESULT_ACTION_TYPE_ID
        WHERE P.STOREN_MATCHING_DONE_ID IS NOT NULL

        UNION ALL
        -- 6. 스토렌_최종반환
        SELECT
            '스토렌_최종반환'                          AS "배송종류"
             , -1                                        AS "발송인"
             , ER.USER_CODE                              AS "수취인"
             , S.STOREN_ID                               AS "스토렌ID"
             , NULL                                      AS "보관ID"
             , NULL                                      AS "렌탈매칭완료ID"
             , NULL                                      AS "렌탈ID"
             , STLR.STOREN_LAST_RETURN_ID                AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , NULL                                      AS "운송사이름"
             , NULL                                      AS "운송장번호"
             , STLR.DELIVERY_START_DATE                  AS "배송시작일"
             , STLR.DELIVERY_END_DATE                    AS "배송종료일"
             , IRA.COMPLETED_DATE                        AS "검수결과처리일"
             , IRAT.INSPEC_RESULT_ACTION_TYPE_NAME       AS "검수결과처리유형"
             , NULL                                      AS "렌탈시작일"
             , NULL                                      AS "렌탈종료일"
        FROM STOREN_LAST_RETURN STLR
                 JOIN STOREN S
                      ON STLR.STOREN_ID = S.STOREN_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN INSPEC_RESULT_ACTION IRA
                      ON STLR.INSPEC_RESULT_ACTION_ID = IRA.INSPEC_RESULT_ACTION_ID
                 JOIN INSPEC_RESULT_ACTION_TYPE IRAT
                      ON IRA.INSPEC_RESULT_ACTION_TYPE_ID = IRAT.INSPEC_RESULT_ACTION_TYPE_ID

        UNION ALL
        -- 7. 보관_최종반환
        SELECT
            '보관_최종반환'                          AS "배송종류"
             , -1                                        AS "발송인"
             , ER.USER_CODE                              AS "수취인"
             , NULL                                      AS "스토렌ID"
             , S.STORAGE_ID                              AS "보관ID"
             , NULL                                      AS "렌탈매칭완료ID"
             , NULL                                      AS "렌탈ID"
             , STLR.STORAGE_LAST_RETURN_ID               AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , NULL                                      AS "운송사이름"
             , NULL                                      AS "운송장번호"
             , STLR.DELIVERY_START_DATE                  AS "배송시작일"
             , STLR.DELIVERY_END_DATE                    AS "배송종료일"
             , IRA.COMPLETED_DATE                        AS "검수결과처리일"
             , IRAT.INSPEC_RESULT_ACTION_TYPE_NAME       AS "검수결과처리유형"
             , NULL                                      AS "렌탈시작일"
             , NULL                                      AS "렌탈종료일"
        FROM STORAGE_LAST_RETURN STLR
                 JOIN STORAGE S
                      ON STLR.STORAGE_ID = S.STORAGE_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN INSPEC_RESULT_ACTION IRA
                      ON STLR.INSPEC_RESULT_ACTION_ID = IRA.INSPEC_RESULT_ACTION_ID
                 JOIN INSPEC_RESULT_ACTION_TYPE IRAT
                      ON IRA.INSPEC_RESULT_ACTION_TYPE_ID = IRAT.INSPEC_RESULT_ACTION_TYPE_ID

        UNION ALL
        -- 8. 렌탈_사용자배송_반납
        SELECT
            '렌탈_반납'                                AS "배송종류"
             , RMR.RENTAL_MATCHING_REQUESTER_ID          AS "발송인"
             , ER.USER_CODE                              AS "수취인"
             , P.STOREN_ID                               AS "스토렌ID"
             , P.STORAGE_ID                              AS "보관ID"
             , P.RENTAL_MATCHING_DONE_ID                 AS "렌탈매칭완료ID"
             , R.RENTAL_ID                               AS "렌탈ID"
             , UDR.USERS_DELIVERY_RETURN_ID              AS "배송ID"
             , EN.EQUIP_NAME                             AS "장비명"
             , UDR.CARRIER_NAME                          AS "운송사이름"
             , UDR.WAYBILL_NUMBER                        AS "운송장번호"
             , UDR.WAYBILL_ENTRY_DATE                    AS "배송시작일"
             , UDR.DELIVERY_END_DATE                     AS "배송종료일"
             , NULL                                      AS "검수결과처리일"
             , NULL                                      AS "검수결과처리유형"
             , RMR.RENTAL_START_DATE                     AS "렌탈시작일"
             , RMR.RENTAL_END_DATE                       AS "렌탈종료일"
        FROM USERS_DELIVERY UD
                 JOIN PAY P
                      ON UD.PAY_ID = P.PAY_ID
                 JOIN RENTAL_MATCHING_DONE RMD
                      ON P.RENTAL_MATCHING_DONE_ID = RMD.RENTAL_MATCHING_DONE_ID
                 JOIN RENTAL_MATCHING_REQ RMR
                      ON RMD.RENTAL_MATCHING_REQ_ID = RMR.RENTAL_MATCHING_REQ_ID
                 JOIN RENTAL R
                      ON RMR.RENTAL_ID = R.RENTAL_ID
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON R.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
                 JOIN USERS_DELIVERY_RETURN UDR
                      ON UD.USERS_DELIVERY_ID = UDR.USERS_DELIVERY_ID
        WHERE P.RENTAL_MATCHING_DONE_ID IS NOT NULL
    </sql>

    <!-- 전체 배송 정보 조회 -->
    <select id="getAllDeliveries" resultMap="deliveryResultMap">
        <include refid="baseDeliveryQuery" />
    </select>

    <!-- 배송 종류별 배송 정보 조회 -->
    <select id="getDeliveriesByType" parameterType="string" resultMap="deliveryResultMap">
        SELECT * FROM (
        <include refid="baseDeliveryQuery" />
        ) WHERE "배송종류" = #{deliveryType}
    </select>

    <!-- 특정 ID의 배송 정보 조회 -->
    <select id="getDeliveryById" parameterType="long" resultMap="deliveryResultMap">
        SELECT * FROM (
        <include refid="baseDeliveryQuery" />
        ) WHERE "배송ID" = #{deliveryId}
    </select>

    <!-- 배송 정보 업데이트 -->
    <update id="updateDelivery" parameterType="com.team.mvc.DTO.AdminDeliveryUpdateDTO">
        <!-- 배송 유형에 따라 다른 테이블을 업데이트 -->
        <choose>
            <when test="deliveryType == '플랫폼 배송' or deliveryType == 'platform'">
                UPDATE PLATFORM_DELIVERY
                SET DELIVERY_START_DATE = #{deliveryStartDate},
                DELIVERY_END_DATE = #{deliveryEndDate}
                WHERE PLATFORM_DELIVERY_ID = #{deliveryId}
            </when>
            <when test="deliveryType == '플랫폼 배송 반환' or deliveryType == 'platform-return'">
                UPDATE PLATFORM_DELIVERY_RETURN
                SET DELIVERY_START_DATE = #{deliveryStartDate},
                DELIVERY_END_DATE = #{deliveryEndDate}
                WHERE PLATFORM_DELIVERY_RETURN_ID = #{deliveryId}
            </when>
            <when test="deliveryType == '거래자 택배' or deliveryType == 'user'">
                UPDATE USERS_DELIVERY
                SET WAYBILL_ENTRY_DATE = #{deliveryStartDate},
                DELIVERY_END_DATE = #{deliveryEndDate},
                CARRIER_NAME = #{carrierName},
                WAYBILL_NUMBER = #{waybillNumber}
                WHERE USERS_DELIVERY_ID = #{deliveryId}
            </when>
            <when test="deliveryType == '거래자 택배 반환' or deliveryType == 'user-return'">
                UPDATE USERS_DELIVERY_RETURN
                SET WAYBILL_ENTRY_DATE = #{deliveryStartDate},
                DELIVERY_END_DATE = #{deliveryEndDate},
                CARRIER_NAME = #{carrierName},
                WAYBILL_NUMBER = #{waybillNumber}
                WHERE USERS_DELIVERY_RETURN_ID = #{deliveryId}
            </when>
            <when test="deliveryType == '보관 최종 반환' or deliveryType == 'storage-return'">
                UPDATE STORAGE_LAST_RETURN
                SET DELIVERY_START_DATE = #{deliveryStartDate},
                DELIVERY_END_DATE = #{deliveryEndDate}
                WHERE STORAGE_LAST_RETURN_ID = #{deliveryId}
            </when>
            <when test="deliveryType == '스토렌 최종 반환' or deliveryType == 'storen-return'">
                UPDATE STOREN_LAST_RETURN
                SET DELIVERY_START_DATE = #{deliveryStartDate},
                DELIVERY_END_DATE = #{deliveryEndDate}
                WHERE STOREN_LAST_RETURN_ID = #{deliveryId}
            </when>
        </choose>
    </update>


    <!-- 배송 시작 전 스토렌 장비 목록 조회 -->
    <select id="getPendingDeliveries" resultMap="deliveryResultMap">
        SELECT
            '스토렌_배송대기'                     AS "배송종류"
             , ER.USER_CODE                         AS "발송인"
             , -1                                   AS "수취인"
             , S.STOREN_ID                          AS "스토렌ID"
             , NULL                                 AS "보관ID"
             , NULL                                 AS "렌탈매칭완료ID"
             , NULL                                 AS "렌탈ID"
             , NULL                                 AS "배송ID"
             , EN.EQUIP_NAME                        AS "장비명"
             , NULL                                 AS "운송사이름"
             , NULL                                 AS "운송장번호"
             , NULL                                 AS "배송시작일"
             , NULL                                 AS "배송종료일"
             , NULL                                 AS "검수결과처리일"
             , NULL                                 AS "검수결과처리유형"
             , NULL                                 AS "렌탈시작일"
             , NULL                                 AS "렌탈종료일"
        FROM STOREN S
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
        WHERE NOT EXISTS (
            SELECT 1 FROM PAY P
                              JOIN PLATFORM_DELIVERY PD ON P.PAY_ID = PD.PAY_ID
            WHERE P.STOREN_ID = S.STOREN_ID
        )
          AND S.STOREN_ID IS NOT NULL

        UNION ALL

        SELECT
            '보관_배송대기'                       AS "배송종류"
             , ER.USER_CODE                         AS "발송인"
             , -1                                   AS "수취인"
             , NULL                                 AS "스토렌ID"
             , S.STORAGE_ID                         AS "보관ID"
             , NULL                                 AS "렌탈매칭완료ID"
             , NULL                                 AS "렌탈ID"
             , NULL                                 AS "배송ID"
             , EN.EQUIP_NAME                        AS "장비명"
             , NULL                                 AS "운송사이름"
             , NULL                                 AS "운송장번호"
             , NULL                                 AS "배송시작일"
             , NULL                                 AS "배송종료일"
             , NULL                                 AS "검수결과처리일"
             , NULL                                 AS "검수결과처리유형"
             , NULL                                 AS "렌탈시작일"
             , NULL                                 AS "렌탈종료일"
        FROM STORAGE S
                 JOIN EQUIPMENT_REGISTRATION ER
                      ON S.EQUIP_CODE = ER.EQUIP_CODE
                 JOIN EQUIP_NAME EN
                      ON ER.EQUIP_NAME_ID = EN.EQUIP_NAME_ID
        WHERE NOT EXISTS (
            SELECT 1 FROM PAY P
                              JOIN PLATFORM_DELIVERY PD ON P.PAY_ID = PD.PAY_ID
            WHERE P.STORAGE_ID = S.STORAGE_ID
        )
          AND S.STORAGE_ID IS NOT NULL
    </select>
    


</mapper>