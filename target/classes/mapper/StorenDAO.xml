<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IStorenDAO">
    <!-- 회원코드로 스토렌 장비 리스트 조회 (해당 회원이 가진 스토렌 장비 리스트) -->
    <select id="listByUserCode" resultType="com.team.mvc.DTO.StorenDTO">
        SELECT STOREN_ID, EQUIP_CODE, USER_CODE
             , SIZE_ID, EQUIP_SIZE_NAME, REQUIRED_SPACE
             , DAILY_STORAGE_FEE, STORE_MONTH
             , STOREN_TITLE, STOREN_CONTENT
             , DAILY_RENT_PRICE, CREATED_DATE
             , NVL(RENTAL_START_DATE, '검수 대기 중') AS rental_start_date
             , NVL(RENTAL_END_DATE, '검수 대기 중') AS rental_end_date
             , MATCHING_REQUEST_COUNT, MATCHING_STATUS
        FROM VW_STOREN
        WHERE USER_CODE = #{user_code}
    </select>

    <!-- 유저 코드와 장비 코드로 스토렌 장비 정보 조회 -->
    <select id="listByUserCodeEquipCode" resultType="com.team.mvc.DTO.StorenDTO">
        SELECT STOREN_ID, EQUIP_CODE, USER_CODE
             , SIZE_ID, EQUIP_SIZE_NAME, REQUIRED_SPACE
             , DAILY_STORAGE_FEE, STORE_MONTH
             , STOREN_TITLE, STOREN_CONTENT
             , DAILY_RENT_PRICE, CREATED_DATE
             , NVL(RENTAL_START_DATE, '검수 대기 중') AS rental_start_date
             , NVL(RENTAL_END_DATE, '검수 대기 중') AS rental_end_date
             , MATCHING_REQUEST_COUNT, MATCHING_STATUS
        FROM VW_STOREN
        WHERE USER_CODE = #{user_code} AND EQUIP_CODE = #{equip_code}
    </select>

    <!-- 처음 스토렌 신청했을 때의 스토렌 정보 가져오기-->
    <select id="getStorenByEquipCode" resultType="com.team.mvc.DTO.StorenDTO">
        SELECT *
        FROM (
                 SELECT STOREN_ID, EQUIP_CODE, USER_CODE
                      , SIZE_ID, EQUIP_SIZE_NAME, REQUIRED_SPACE
                      , DAILY_STORAGE_FEE, STORE_MONTH
                      , STOREN_TITLE, STOREN_CONTENT
                      , DAILY_RENT_PRICE, CREATED_DATE
                      , NVL(RENTAL_START_DATE, '검수 대기 중') AS rental_start_date
                      , NVL(RENTAL_END_DATE, '검수 대기 중') AS rental_end_date
                      , MATCHING_REQUEST_COUNT, MATCHING_STATUS
                 FROM VW_STOREN
                 WHERE USER_CODE = #{user_code} AND EQUIP_CODE = #{equip_code}
                 ORDER BY CREATED_DATE ASC
             )
        WHERE ROWNUM = 1
    </select>


    <!-- 매칭 신청 수가 1 이상인 스토렌 리스트 가져오기 -->
    <select id="listMatchingStorenByUserCode" resultType="com.team.mvc.DTO.StorenDTO">
        SELECT STOREN_ID, EQUIP_CODE, USER_CODE
             , SIZE_ID, EQUIP_SIZE_NAME, REQUIRED_SPACE
             , DAILY_STORAGE_FEE, STORE_MONTH
             , STOREN_TITLE, STOREN_CONTENT
             , DAILY_RENT_PRICE, CREATED_DATE
             , NVL(RENTAL_START_DATE, '검수 대기 중') AS rental_start_date
             , NVL(RENTAL_END_DATE, '검수 대기 중') AS rental_end_date
             , MATCHING_REQUEST_COUNT, MATCHING_STATUS
        FROM VW_STOREN
        WHERE USER_CODE = #{user_code} AND MATCHING_REQUEST_COUNT > 0
    </select>

    <!-- 내가 매칭 신청한 스토렌 리스트 가져오기 -->
    <select id="listMyStorenApplicationsByUserCode" resultType="com.team.mvc.DTO.StorenDTO">
        SELECT
        s.*
        FROM
        VW_STOREN s
        WHERE
        s.STOREN_ID IN (
        SELECT
        TRANSACTION_ID
        FROM
        VW_RENTAL_APPLICANT
        WHERE
        USER_CODE = #{userCode}
        AND TRANSACTION_TYPE LIKE '스토렌%'
        )
        <if test="matchingStatus != null">
            AND s.MATCHING_STATUS = #{matchingStatus}
        </if>
        ORDER BY s.CREATED_DATE DESC
    </select>

</mapper>