<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team.mvc.Interface.IAdminInspectListDAO">

    <!-- 1차 검수 목록 조회 수정 쿼리 -->
    <select id="getList" resultType="com.team.mvc.DTO.AdminInspectListDTO">
        SELECT
            e.EQUIP_CODE as equipCode,
            pd.PLATFORM_DELIVERY_ID as platformDeliveryId,
            '입고검수' as inspectName,
            en.EQUIP_NAME as equipName,
            c.CATEGORY_NAME as categoryName,
            COALESCE(i.INSPEC_ITEM_NAME, '검수대기') as inspectList,
            COALESCE(a.ADMIN_ID, 'ADMIN1') as adminId,
            ig.INSPEC_GRADE_NAME as inspectResult,
            il.INSPEC_COMMENT as inspectComment,
            eg.EQUIP_GRADE_NAME as finalGrade,
            CASE
                WHEN ir.INSPEC_RESULT_ID IS NULL THEN '검수대기'
                ELSE '검수완료'
                END as inspectState
        FROM PLATFORM_DELIVERY pd
                 LEFT JOIN PAY p ON pd.PAY_ID = p.PAY_ID
                 LEFT JOIN EQUIPMENT_REGISTRATION e ON p.STOREN_ID = e.EQUIP_ID OR p.STORAGE_ID = e.EQUIP_ID
                 LEFT JOIN EQUIP_NAME en ON e.EQUIP_NAME_ID = en.EQUIP_NAME_ID
                 LEFT JOIN CATEGORY c ON e.CATEGORY_ID = c.CATEGORY_ID
                 LEFT JOIN INSPEC_LIST il ON pd.PLATFORM_DELIVERY_ID = il.PLATFORM_DELIVERY_ID
                 LEFT JOIN INSPEC_RESULT ir ON pd.PLATFORM_DELIVERY_ID = ir.PLATFORM_DELIVERY_ID
                 LEFT JOIN CATE_INSPEC ci ON il.CATE_INSPEC_ID = ci.CATE_INSPEC_ID
                 LEFT JOIN INSPEC_ITEM i ON ci.INSPEC_ITEM_ID = i.INSPEC_ITEM_ID
                 LEFT JOIN INSPEC_GRADE ig ON il.INSPEC_GRADE_ID = ig.INSPEC_GRADE_ID
                 LEFT JOIN ADMINS a ON il.ADMIN_ID = a.ADMIN_ID
                 LEFT JOIN EQUIP_GRADE eg ON ir.EQUIP_GRADE_ID = eg.EQUIP_GRADE_ID
        WHERE pd.PLATFORM_DELIVERY_ID IS NOT NULL
            /* 아래 조건 제거 */
          AND (ir.INSPEC_RESULT_ID IS NULL OR ir.PLATFORM_DELIVERY_RETURN_ID IS NULL)
        ORDER BY pd.PLATFORM_DELIVERY_ID DESC
    </select>

    <!-- 2차 검수 목록 조회 (반환 검수) 수정 쿼리 -->
    <select id="getListr" resultType="com.team.mvc.DTO.AdminInspectListDTO">
        SELECT
            e.EQUIP_CODE as equipCode,
            '스토렌반환검수' as inspectName,
            en.EQUIP_NAME as equipName,
            pd.PLATFORM_DELIVERY_ID as platformDeliveryId,
            pdr.PLATFORM_DELIVERY_RETURN_ID as platformDeliveryReturnId,
            c.CATEGORY_NAME as categoryName,
            COALESCE(i.INSPEC_ITEM_NAME, '검수대기') as inspectList,
            COALESCE(a.ADMIN_ID, 'ADMIN1') as adminId,
            ig.INSPEC_GRADE_NAME as inspectResult,
            il.INSPEC_COMMENT as inspectComment,
            eg.EQUIP_GRADE_NAME as finalGrade,
            CASE
                WHEN ir.INSPEC_RESULT_ID IS NULL THEN '검수대기'
                ELSE '검수완료'
                END as inspectState
        FROM PLATFORM_DELIVERY_RETURN pdr
                 JOIN PLATFORM_DELIVERY pd ON pdr.PLATFORM_DELIVERY_ID = pd.PLATFORM_DELIVERY_ID
                 JOIN PAY p ON pd.PAY_ID = p.PAY_ID
                 JOIN EQUIPMENT_REGISTRATION e ON p.STOREN_ID = e.EQUIP_ID OR p.STORAGE_ID = e.EQUIP_ID
                 JOIN EQUIP_NAME en ON e.EQUIP_NAME_ID = en.EQUIP_NAME_ID
                 JOIN CATEGORY c ON e.CATEGORY_ID = c.CATEGORY_ID
                 LEFT JOIN INSPEC_LIST il ON pdr.PLATFORM_DELIVERY_RETURN_ID = il.PLATFORM_DELIVERY_RETURN_ID
                 LEFT JOIN INSPEC_RESULT ir ON pdr.PLATFORM_DELIVERY_RETURN_ID = ir.PLATFORM_DELIVERY_RETURN_ID
                 LEFT JOIN CATE_INSPEC ci ON il.CATE_INSPEC_ID = ci.CATE_INSPEC_ID
                 LEFT JOIN INSPEC_ITEM i ON ci.INSPEC_ITEM_ID = i.INSPEC_ITEM_ID
                 LEFT JOIN INSPEC_GRADE ig ON il.INSPEC_GRADE_ID = ig.INSPEC_GRADE_ID
                 LEFT JOIN ADMINS a ON il.ADMIN_ID = a.ADMIN_ID
                 LEFT JOIN EQUIP_GRADE eg ON ir.EQUIP_GRADE_ID = eg.EQUIP_GRADE_ID
        WHERE pdr.PLATFORM_DELIVERY_RETURN_ID IS NOT NULL
        ORDER BY pdr.PLATFORM_DELIVERY_RETURN_ID DESC
    </select>

    <!-- 검수 항목 조회 -->
    <select id="getItemList" resultType="com.team.mvc.DTO.AdminInspectListDTO">
        SELECT
            INSPEC_ITEM_ID as inspecItemId,
            INSPEC_ITEM_NAME as inspecItemName,
            INSPEC_ITEM_DESC_HIGH as inspecItemDescHigh,
            INSPEC_ITEM_DESC_MID as inspecItemDescMid,
            INSPEC_ITEM_DESC_LOW as inspecItemDescLow
        FROM INSPEC_ITEM
    </select>

    <!-- 검수 등급 조회 -->
    <select id="getGradeList" resultType="com.team.mvc.DTO.AdminInspectListDTO">
        SELECT
            INSPEC_GRADE_ID as inspecGradeId,
            INSPEC_GRADE_NAME as inspecGradeName,
            INSPEC_GRADE_DEDUCTION as inspecGradeDeduction
        FROM INSPEC_GRADE
        ORDER BY INSPEC_GRADE_ID
    </select>

    <!-- 장비 목록 조회 -->
    <select id="getEquipList" resultType="com.team.mvc.DTO.AdminInspectListDTO">
        SELECT
            e.EQUIP_CODE as equipCode,
            en.EQUIP_NAME as equipName,
            c.CATEGORY_NAME as categoryName
        FROM EQUIPMENT_REGISTRATION e
                 JOIN EQUIP_NAME en ON e.EQUIP_NAME_ID = en.EQUIP_NAME_ID
                 JOIN CATEGORY c ON e.CATEGORY_ID = c.CATEGORY_ID
    </select>

    <!-- 확장된 검수 결과 등록 프로시저 호출 -->
    <update id="callINSPECT_RESULT">
        {CALL INSPECT_RESULT(
                #{platformDeliveryId, jdbcType=INTEGER, mode=IN},
                #{platformDeliveryReturnId, jdbcType=INTEGER, mode=IN},
                #{inspecGradeId, jdbcType=INTEGER, mode=IN},
                #{equipGradeId, jdbcType=INTEGER, mode=IN},
                #{adminId, jdbcType=VARCHAR, mode=IN},
                #{inspecComment, jdbcType=VARCHAR, mode=IN}
              )}
    </update>

    <!-- 반환 ID에 해당하는 원래 배송 ID 조회 -->
    <select id="getDeliveryIdFromReturnId" resultType="int">
        SELECT PLATFORM_DELIVERY_ID
        FROM PLATFORM_DELIVERY_RETURN
        WHERE PLATFORM_DELIVERY_RETURN_ID = #{returnId}
    </select>

    <!-- 검수 결과 상세 조회 추가 -->
    <select id="getInspectionResult" resultType="com.team.mvc.DTO.AdminInspectListDTO">
        SELECT
        ir.INSPEC_RESULT_ID as inspecResultId,
        il.INSPEC_COMMENT as inspectComment,
        ig.INSPEC_GRADE_NAME as inspectResult,
        eg.EQUIP_GRADE_NAME as finalGrade
        FROM INSPEC_RESULT ir
        JOIN INSPEC_LIST il ON (
        (ir.PLATFORM_DELIVERY_ID = il.PLATFORM_DELIVERY_ID AND ir.PLATFORM_DELIVERY_ID IS NOT NULL) OR
        (ir.PLATFORM_DELIVERY_RETURN_ID = il.PLATFORM_DELIVERY_RETURN_ID AND ir.PLATFORM_DELIVERY_RETURN_ID IS NOT NULL)
        )
        JOIN INSPEC_GRADE ig ON il.INSPEC_GRADE_ID = ig.INSPEC_GRADE_ID
        JOIN EQUIP_GRADE eg ON ir.EQUIP_GRADE_ID = eg.EQUIP_GRADE_ID
        WHERE
        <if test="platformDeliveryId != null">
            ir.PLATFORM_DELIVERY_ID = #{platformDeliveryId}
            <if test="platformDeliveryReturnId == null">
                AND ir.PLATFORM_DELIVERY_RETURN_ID IS NULL
            </if>
        </if>
        <if test="platformDeliveryReturnId != null">
            ir.PLATFORM_DELIVERY_RETURN_ID = #{platformDeliveryReturnId}
        </if>
    </select>
</mapper>