<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IAdminUserListDAO">
    <resultMap id="userList" type="com.team.mvc.DTO.AdminUserListDTO">
        <result property="userCode" column="회원코드"/>
        <result property="userId" column="회원ID"/>
        <result property="userName" column="회원이름"/>
        <result property="userTel" column="회원전화번호"/>
        <result property="userEmail" column="회원이메일"/>
        <result property="signupType" column="가입유형"/>
        <result property="createdDate" column="회원가입일"/>
        <result property="currentNickname" column="현재닉네임"/>
        <result property="currentRank" column="현재등급"/>
        <result property="totalPoints" column="총보유포인트"/>
        <result property="postCount" column="게시물수"/>
        <result property="replyCount" column="댓글수"/>
        <result property="bookmarkCount" column="북마크수"/>
        <result property="recommendCount" column="추천수"/>
        <result property="equipmentCount" column="장비등록수"/>
        <result property="rentalCount" column="렌탈등록수"/>
        <result property="storenCount" column="스토렌등록수"/>
        <result property="storageCount" column="보관등록수"/>
        <result property="avgSatisfactionScore" column="평균만족도점수"/>
        <result property="couponCount" column="보유쿠폰수"/>
        <result property="currentAddress" column="현재주소"/>
        <result property="currentDetailAddress" column="현재상세주소"/>
        <result property="userStatus" column="회원상태"/>
        <result property="exitDate" column="탈퇴일자"/>
    </resultMap>

    <select id="getList" resultMap="userList">
        SELECT
            UC.USER_CODE AS "회원코드",
            U.USER_ID AS "회원ID",
            U.USER_NAME AS "회원이름",
            U.USER_TEL AS "회원전화번호",
            U.USER_EMAIL AS "회원이메일",
            ST.SIGNUP_TYPE_NAME AS "가입유형",
            U.CREATED_DATE AS "회원가입일",
            (SELECT NICKNAME
             FROM NICKNAME_LOG NL
             WHERE NL.USER_CODE = UC.USER_CODE
               AND NL.LAST_UPDATED_DATE = (SELECT MAX(LAST_UPDATED_DATE)
                                           FROM NICKNAME_LOG
                                           WHERE USER_CODE = UC.USER_CODE)) AS "현재닉네임",
            (SELECT MAX(RANK_NAME)
             FROM RANK R
             WHERE (SELECT NVL(SUM(POINT_CHANGE),0)
                    FROM POINT_LOG
                    WHERE USER_CODE = UC.USER_CODE) <![CDATA[>=]]> R.MIN_POINT AND (SELECT NVL(SUM(POINT_CHANGE),0)
                                                                                    FROM POINT_LOG
                                                                                    WHERE USER_CODE = UC.USER_CODE) <![CDATA[<=]]> R.MAX_POINT) AS "현재등급",
            (SELECT NVL(SUM(POINT_CHANGE),0)
             FROM POINT_LOG
             WHERE USER_CODE = UC.USER_CODE) AS "총보유포인트",
            (SELECT COUNT(*)
             FROM POST
             WHERE USER_CODE = UC.USER_CODE) AS "게시물수",
            (SELECT COUNT(*)
             FROM REPLY
             WHERE USER_CODE = UC.USER_CODE) AS "댓글수",
            (SELECT COUNT(*)
             FROM BOOKMARK
             WHERE USER_CODE = UC.USER_CODE) AS "북마크수",
            (SELECT COUNT(*)
             FROM RECOMMEND
             WHERE USER_CODE = UC.USER_CODE) AS "추천수",
            (SELECT COUNT(*)
             FROM EQUIPMENT_REGISTRATION
             WHERE USER_CODE = UC.USER_CODE) AS "장비등록수",
            (SELECT COUNT(*)
             FROM RENTAL
             WHERE EQUIP_CODE IN (SELECT EQUIP_CODE
                                  FROM EQUIPMENT_REGISTRATION
                                  WHERE USER_CODE = UC.USER_CODE)) AS "렌탈등록수",
            (SELECT COUNT(*)
             FROM STOREN
             WHERE EQUIP_CODE IN (SELECT EQUIP_CODE
                                  FROM EQUIPMENT_REGISTRATION
                                  WHERE USER_CODE = UC.USER_CODE)) AS "스토렌등록수",
            (SELECT COUNT(*)
             FROM STORAGE
             WHERE EQUIP_CODE IN (SELECT EQUIP_CODE
                                  FROM EQUIPMENT_REGISTRATION
                                  WHERE USER_CODE = UC.USER_CODE)) AS "보관등록수",
            (SELECT AVG(SATIS_SCORE)
             FROM SATISFACTION_LOG
             WHERE REVIEWEE_ID = UC.USER_CODE) AS "평균만족도점수",
            (SELECT COUNT(*)
             FROM SATISFACTION_LOG
             WHERE REVIEWEE_ID = UC.USER_CODE) AS "리뷰건수",
            (SELECT COUNT(*)
             FROM OWNED_COUPON
             WHERE USER_CODE = UC.USER_CODE AND COMPLETED_DATE IS NULL) AS "보유쿠폰수",
            (SELECT ADDRESS1
             FROM ADDRESS_LOG
             WHERE USER_CODE = UC.USER_CODE
               AND LAST_UPDATED_DATE = (SELECT MAX(LAST_UPDATED_DATE)
                                        FROM ADDRESS_LOG
                                        WHERE USER_CODE = UC.USER_CODE)) AS "현재주소",
            (SELECT ADDRESS2
             FROM ADDRESS_LOG
             WHERE USER_CODE = UC.USER_CODE
               AND LAST_UPDATED_DATE = (SELECT MAX(LAST_UPDATED_DATE)
                                        FROM ADDRESS_LOG
                                        WHERE USER_CODE = UC.USER_CODE)) AS "현재상세주소",
            CASE
                WHEN EXISTS (SELECT 1 FROM SUSPENDED_USER SU WHERE SU.USER_CODE = UC.USER_CODE AND SU.SUSPENDED_START_DATE <![CDATA[<=]]> SYSDATE)
                    THEN '활동정지'
                WHEN UC.EXIT_DATE IS NOT NULL
                    THEN '탈퇴'
                ELSE '활동중'
                END AS "회원상태",
            UC.EXIT_DATE AS "탈퇴일자"
        FROM
            USER_CODE UC
                LEFT JOIN USERS U ON UC.USER_CODE = U.USER_CODE
                LEFT JOIN SIGNUP_TYPE ST ON U.SIGNUP_TYPE_ID = ST.SIGNUP_TYPE_ID
        ORDER BY
            UC.USER_CODE
    </select>
</mapper>