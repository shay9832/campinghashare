<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.mvc.Interface.IEquipmentDAO">

    <resultMap id="equipmentResultMap" type="com.team.mvc.DTO.EquipmentDTO">
        <result column="EQUIP_ID" property="equip_id"/>
        <result column="EQUIP_CODE" property="equip_code"/>
        <result column="USER_CODE" property="user_code"/>
        <result column="CATEGORY_ID" property="category_id"/>
        <result column="EQUIP_NAME_ID" property="equip_name_id"/>
        <result column="EQUIP_NAME" property="equip_name"/>
        <result column="BRAND_NAME" property="brand"/>
        <result column="ORIGINAL_PRICE" property="original_price"/>
        <result column="CREATED_DATE" property="created_date"/>
        <result column="MAJOR_CATEGORY_NAME" property="majorCategory"/>
        <result column="MIDDLE_CATEGORY_NAME" property="middleCategory"/>
    </resultMap>

    <!-- 장비코드 생성 -->
    <insert id="insertEquipCode" parameterType="com.team.mvc.DTO.EquipmentDTO" statementType="CALLABLE">
        <selectKey keyProperty="equip_code" resultType="int" order="BEFORE">
            SELECT EQUIP_CODE_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO EQUIP_CODE(EQUIP_CODE)
        VALUES (
        #{equip_code}
        )
    </insert>


    <!-- 장비 정보를 테이블에 저장 -->
    <insert id="insertEquipmentRegistration" parameterType="com.team.mvc.DTO.EquipmentDTO">
        INSERT INTO EQUIPMENT_REGISTRATION(
            EQUIP_ID, EQUIP_CODE, USER_CODE, CATEGORY_ID, EQUIP_NAME_ID, ORIGINAL_PRICE, CREATED_DATE
        )
        VALUES (
                   EQUIPMENT_REGISTRATION_SEQ.NEXTVAL,
                   #{equip_code},
                   #{user_code},
                   #{category_id},
                   #{equip_name_id},
                   #{original_price},
                   SYSDATE
               )
    </insert>

    <!-- 브랜드 ID 조회 -->
    <select id="getEquipNameId" resultType="Integer">
        SELECT EQUIP_NAME_ID
        FROM EQUIP_NAME
        WHERE BRAND_ID = #{brandId}
          AND EQUIP_NAME = #{equipName}
    </select>


    <!-- 브랜드별 장비명과 평균 신품가격 -->
    <select id="listEquipNamesByBrand" resultType="java.util.HashMap">
        SELECT EN.EQUIP_NAME AS equipName,
               CASE
                   WHEN EN.EQUIP_NAME = '기타' THEN 0
                   ELSE NVL(VEP."평균신품가", 0)
                   END       AS price
        FROM EQUIP_NAME EN
                 LEFT JOIN VW_EQUIP_ORIGINAL_PRICE VEP
                           ON EN.EQUIP_NAME = VEP."장비명"
        WHERE EN.BRAND_ID = #{brandId}
        GROUP BY EN.EQUIP_NAME, VEP."평균신품가"
        ORDER BY CASE
                     WHEN EN.EQUIP_NAME = '기타' THEN 1
                     ELSE 0
                     END, EN.EQUIP_NAME
    </select>


    <!-- 유저 코드로 장비 정보 조회 -->
    <select id="listByUserCode" resultType="com.team.mvc.DTO.EquipmentDTO" resultMap="equipmentResultMap">
        SELECT EQUIP_ID, EQUIP_CODE, USER_CODE, CATEGORY_ID
             , MAJOR_CATEGORY_NAME, MIDDLE_CATEGORY_NAME
             , EQUIP_NAME_ID, EQUIP_NAME, BRAND_NAME, ORIGINAL_PRICE, CREATED_DATE
        FROM VW_EQUIPMENT
        WHERE USER_CODE = #{user_code}
    </select>

    <!-- 장비명id로 장비명 조회 -->
    <select id="getEquipNameById">
        SELECT EQUIP_NAME
        FROM EQUIP_NAME
        WHERE EQUIP_NAME_ID = #{equip_name_id}
    </select>

    <!-- 장비코드로 장비정보 조회 -->
    <select id="getEquipmentByEquipCode" resultType="com.team.mvc.DTO.EquipmentDTO" resultMap="equipmentResultMap">
        SELECT EQUIP_ID, EQUIP_CODE, USER_CODE, CATEGORY_ID
             , MAJOR_CATEGORY_NAME, MIDDLE_CATEGORY_NAME
             , EQUIP_NAME_ID, EQUIP_NAME, BRAND_NAME, ORIGINAL_PRICE, CREATED_DATE
        FROM VW_EQUIPMENT
        WHERE EQUIP_CODE = #{equip_code}
    </select>

    <!-- 전체 장비 정보 조회 -->
    <select id="listEquip" resultType="com.team.mvc.DTO.EquipmentDTO" resultMap="equipmentResultMap">
        SELECT EQUIP_ID, EQUIP_CODE, USER_CODE, CATEGORY_ID
             , MAJOR_CATEGORY_NAME, MIDDLE_CATEGORY_NAME
             , EQUIP_NAME_ID, EQUIP_NAME, BRAND_NAME, ORIGINAL_PRICE, CREATED_DATE
        FROM VW_EQUIPMENT
    </select>
</mapper>